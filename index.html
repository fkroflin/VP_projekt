<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pokédex</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: #f0f0f0;
      font-family: sans-serif;
    }
    svg {
      display: block;
      margin: 30px auto;
      background-color: #e74c3c;
      border-radius: 30px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.5);
      width: 930px;
      height: 630px;
    }
    #pokemon-name {
      fill: #ecf0f1;
      font-size: 30px;
      font-weight: bold;
      text-anchor: middle;
      text-transform: uppercase;
    }
    #pokemon-sprite {
      image-rendering: pixelated;
    }
    .dpad-button {
      cursor: pointer;
      transition: fill 0.2s;
    }
    .dpad-button:hover {
      fill: #1a252f;
    }
    .dpad-button:active {
      fill: #0f151a;
    }
    .stat-label {
      fill: #ecf0f1;
      font-size: 18px;
    }
    .level-indicator {
      fill: #ecf0f1;
      font-size: 21px;
      font-weight: bold;
    }
    .radar-chart {
      fill: none;
      stroke: #ecf0f1;
      stroke-width: 1.5;
    }
    .radar-area {
      stroke: #ecf0f1;
      stroke-width: 3;
    }
    .freeze-button {
      cursor: pointer;
      transition: fill 0.2s;
    }
    .freeze-button:hover {
      fill: #2980b9; /* Darker shade of blue on hover */
    }
    .freeze-button:active {
      fill: #1f6391; /* Even darker shade when pressed */
    }
  </style>
</head>
<body>
  <svg id="pokedex" width="930" height="630"></svg>
  <script>
    // Select the SVG element for the Pokédex
    const svg = d3.select("#pokedex");
    
    // Initialize variables for Pokémon navigation and state
    let currentPokemonId = 1; // Start with the first Pokémon
    let totalPokemon = 0; // Total number of Pokémon (to be determined from data)
    let direction = "right"; // Direction of sprite animation (left or right)
    let pokemonStats = {}; // Store Pokémon stats from the JSON file
    let showingMega = false; // Flag for showing Mega form
    let megaForms = []; // List of Mega forms for the current Pokémon
    let megaIndex = 0; // Index for cycling through Mega forms
    let currentLevel = 1; // Current level of the Pokémon
    let frozenState = null; // Store frozen state: {id, level, points, showingMega, megaIndex}
    let frozenColor = "rgba(255, 215, 0, 0.5)"; // Brighter gold for frozen stats
    let defaultColor = "rgba(236, 240, 241, 0.3)"; // Default color for radar chart

    // Load Pokémon data and initialize display
    d3.json("filtered_pokemons.json").then(data => {
      pokemonStats = data;
      // Count total Pokémon, excluding Mega forms
      totalPokemon = Object.keys(pokemonStats).filter(name => !name.startsWith("Mega")).length;
      if (totalPokemon > 0) {
        updatePokemon(currentPokemonId, false).then(() => {
          console.log("Initial Pokémon loaded: ", currentPokemonId);
        }).catch(error => {
          console.error("Failed to load initial Pokémon: ", error);
        });
      }
    }).catch(error => {
      console.error("Failed to load Pokémon data: ", error);
    });

    // Define a gradient for the Pokédex panels
    const defs = svg.append("defs");
    const gradient = defs.append("linearGradient")
      .attr("id", "panelGradient")
      .attr("x1", "0%").attr("y1", "0%").attr("x2", "100%").attr("y2", "100%");
    gradient.append("stop").attr("offset", "0%").attr("stop-color", "#c0392b");
    gradient.append("stop").attr("offset", "100%").attr("stop-color", "#a5281a");

    // Add a vertical separator between the left and right panels
    svg.append("rect")
      .attr("x", 450).attr("y", 0).attr("width", 30).attr("height", 630)
      .attr("fill", "#8e1e16").attr("rx", 8);

    // Create the left panel group
    const left = svg.append("g").attr("id", "left-panel");
    // Draw the left panel background
    left.append("rect")
      .attr("x", 15).attr("y", 15).attr("width", 450).attr("height", 600)
      .attr("fill", "url(#panelGradient)").attr("rx", 22)
      .attr("stroke", "#8e1e16").attr("stroke-width", 4);

    // Add a blue circle (decorative element) on the left panel
    left.append("circle")
      .attr("cx", 75).attr("cy", 60).attr("r", 30).attr("fill", "#3498db")
      .attr("stroke", "#ecf0f1").attr("stroke-width", 4);

    // Add three LED lights (red, green, yellow) on the left panel
    left.selectAll("circle.led")
      .data([0, 1, 2])
      .enter()
      .append("circle")
      .attr("cx", (d, i) => 150 + i * 30)
      .attr("cy", 60)
      .attr("r", 8)
      .attr("fill", (d, i) => ["#e74c3c", "#2ecc71", "#f1c40f"][i])
      .attr("stroke", "#ecf0f1");

    // Create the main screen group on the left panel
    const screen = left.append("g").attr("id", "main-screen");

    // Define a clip path to mask the Pokémon sprite
    defs.append("clipPath").attr("id", "sprite-mask")
      .append("rect").attr("x", 75).attr("y", 105).attr("width", 330).attr("height", 270);

    // Draw the screen background for the Pokémon display
    screen.append("rect")
      .attr("x", 75).attr("y", 105).attr("width", 330).attr("height", 270)
      .attr("fill", "#222").attr("rx", 15).attr("stroke", "#ecf0f1").attr("stroke-width", 3);

    // Add the Pokémon name text
    const pokemonName = screen.append("text")
      .attr("id", "pokemon-name")
      .attr("x", 240).attr("y", 142)
      .attr("textLength", 300)
      .attr("lengthAdjust", "spacingAndGlyphs");

    // Add the Pokémon sprite image
    const pokemonSprite = screen.append("image")
      .attr("id", "pokemon-sprite")
      .attr("clip-path", "url(#sprite-mask)")
      .attr("x", 165).attr("y", 157)
      .attr("width", 180).attr("height", 180);

    // Create a group for Pokémon type icons
    const typeGroup = screen.append("g").attr("id", "type-group");

    // Add the level indicator text
    const levelText = screen.append("text")
      .attr("x", 330)
      .attr("y", 352)
      .attr("class", "level-indicator")
      .text(`Lv.${currentLevel}`);

    // Create the Mega button group
    const megaButton = left.append("g").attr("id", "mega-button");

    // Draw the Mega button background
    megaButton.append("rect")
      .attr("x", 75).attr("y", 450).attr("width", 150).attr("height", 45)
      .attr("rx", 12)
      .attr("fill", "#2e7d32")
      .attr("stroke", "#1b5e20")
      .attr("stroke-width", 3);

    // Add the "MEGA" text to the button
    megaButton.append("text")
      .attr("x", 150).attr("y", 472)
      .attr("text-anchor", "middle")
      .attr("alignment-baseline", "middle")
      .attr("fill", "#ecf0f1")
      .attr("font-size", "21px")
      .attr("font-weight", "bold")
      .text("MEGA");

    // Add click event to toggle Mega forms with disappear/reappear animation
    megaButton.style("cursor", "pointer")
      .on("click", () => {
        if (!megaForms.length) return; // Do nothing if no Mega forms exist
        showingMega = true;
        megaIndex = (megaIndex + 1) % (megaForms.length + 1); // Cycle through Mega forms
        if (megaIndex === 0) showingMega = false; // Reset to base form
        updatePokemon(currentPokemonId, true); // Update the display with sprite animation
      });

    // Create the D-pad for navigation and level adjustment
    const dpad = left.append("g").attr("transform", "translate(345, 465)");
    const armLength = 30, armThickness = 21, centerSize = 24;

    // D-pad up button (increase level)
    dpad.append("rect")
      .attr("x", -armThickness / 2).attr("y", -armLength - centerSize / 2)
      .attr("width", armThickness).attr("height", armLength)
      .attr("fill", "#2c3e50").attr("class", "dpad-button")
      .on("click", () => adjustLevel(10));

    // D-pad down button (decrease level)
    dpad.append("rect")
      .attr("x", -armThickness / 2).attr("y", centerSize / 2)
      .attr("width", armThickness).attr("height", armLength)
      .attr("fill", "#2c3e50").attr("class", "dpad-button")
      .on("click", () => adjustLevel(-10));

    // D-pad left button (previous Pokémon)
    dpad.append("rect")
      .attr("x", -armLength - centerSize / 2).attr("y", -armThickness / 2)
      .attr("width", armLength).attr("height", armThickness)
      .attr("fill", "#2c3e50").attr("class", "dpad-button")
      .on("click", () => { direction = "left"; scrollLeft(); });

    // D-pad right button (next Pokémon)
    dpad.append("rect")
      .attr("x", centerSize / 2).attr("y", -armThickness / 2)
      .attr("width", armLength).attr("height", armThickness)
      .attr("fill", "#2c3e50").attr("class", "dpad-button")
      .on("click", () => { direction = "right"; scrollRight(); });

    // D-pad center
    dpad.append("rect")
      .attr("x", -centerSize / 2).attr("y", -centerSize / 2)
      .attr("width", centerSize).attr("height", centerSize)
      .attr("fill", "#34495e");

    // Create the right panel group
    const right = svg.append("g").attr("id", "right-panel");
    // Draw the right panel background
    right.append("rect")
      .attr("x", 465).attr("y", 15).attr("width", 450).attr("height", 600)
      .attr("fill", "url(#panelGradient)").attr("rx", 22)
      .attr("stroke", "#8e1e16").attr("stroke-width", 4);

    // Draw the radar chart screen background
    right.append("rect")
      .attr("x", 510).attr("y", 60).attr("width", 360).attr("height", 370)
      .attr("fill", "#222").attr("rx", 15).attr("stroke", "#ecf0f1").attr("stroke-width", 3);

    // Create the radar chart group
    const radarChart = right.append("g")
      .attr("transform", "translate(690, 250) scale(1)");

    const radarWidth = 300;
    const radarHeight = 300;
    const radius = Math.min(radarWidth, radarHeight) / 2;
    const angleSlice = (Math.PI * 2) / 6; // Divide the circle into 6 segments (for 6 stats)

    // Create the axes for the radar chart (HP, ATK, DEF, SPA, SPD, SPE)
    const axes = radarChart.selectAll(".axis")
      .data(["HP", "ATK", "DEF", "SPA", "SPD", "SPE"])
      .enter()
      .append("g")
      .attr("class", "axis");

    // Draw the axis lines
    axes.append("line")
      .attr("x1", 0)
      .attr("y1", 0)
      .attr("x2", (d, i) => radius * Math.cos(angleSlice * i - Math.PI / 2))
      .attr("y2", (d, i) => radius * Math.sin(angleSlice * i - Math.PI / 2))
      .attr("class", "radar-chart");

    // Add labels to the axes
    axes.append("text")
      .attr("x", (d, i) => (radius + 15) * Math.cos(angleSlice * i - Math.PI / 2))
      .attr("y", (d, i) => (radius + 15) * Math.sin(angleSlice * i - Math.PI / 2))
      .attr("text-anchor", "middle")
      .attr("fill", "#ecf0f1")
      .attr("font-size", "15px")
      .text(d => d);

    // Draw concentric polygons for the radar chart levels
    const levels = 5;
    for (let i = 0; i < levels; i++) {
      const levelFactor = radius * (i + 1) / levels;
      radarChart.append("polygon")
        .attr("points", Array.from({length: 6}, (_, j) => {
          const angle = angleSlice * j - Math.PI / 2;
          return `${levelFactor * Math.cos(angle)},${levelFactor * Math.sin(angle)}`;
        }).join(" "))
        .attr("class", "radar-chart")
        .attr("fill", "none")
        .attr("stroke", "#ecf0f1")
        .attr("stroke-width", 1);
    }

    // Create the stat display screen
    const statScreen = right.append("g").attr("id", "stat-screen");
    // Draw the stat screen background
    statScreen.append("rect")
      .attr("x", 510).attr("y", 450).attr("width", 360).attr("height", 75)
      .attr("fill", "#222").attr("rx", 8).attr("stroke", "#ecf0f1").attr("stroke-width", 3);

    // Create a grid for the blue buttons
    const btnGrid = right.append("g").attr("transform", "translate(510, 540)");
    const buttonData = [
      { label: "FREEZE", class: "freeze-button" }, // First button is the freeze button
      { label: "", class: "blue-btn" },
      { label: "", class: "blue-btn" }
    ];

    // Draw the blue buttons
    const buttons = btnGrid.selectAll("g.button")
      .data(buttonData)
      .enter()
      .append("g")
      .attr("class", "button")
      .attr("transform", (d, i) => `translate(${(i % 3) * 90}, ${Math.floor(i / 3) * 60})`);

    // Add the button rectangles
    buttons.append("rect")
      .attr("x", 0)
      .attr("y", 0)
      .attr("width", 75).attr("height", 45)
      .attr("fill", "#3498db").attr("rx", 8)
      .attr("stroke", "#2980b9").attr("stroke-width", 3)
      .attr("class", d => d.class);

    // Add the "FREEZE" label to the first button
    buttons.filter(d => d.label === "FREEZE")
      .append("text")
      .attr("x", 37)
      .attr("y", 23)
      .attr("text-anchor", "middle")
      .attr("alignment-baseline", "middle")
      .attr("fill", "#ecf0f1")
      .attr("font-size", "14px")
      .attr("font-weight", "bold")
      .text("FREEZE");

    // Add click event to the freeze button
    btnGrid.select(".freeze-button")
      .on("click", () => {
        const radarArea = d3.select(".radar-area").filter(function() {
          return d3.select(this).attr("data-type") === "current";
        });
        if (!radarArea.empty()) {
          const currentPoints = radarArea.attr("points");

          if (!frozenState) {
            // Freeze the current Pokémon's stats
            frozenState = {
              id: currentPokemonId,
              level: currentLevel,
              points: currentPoints,
              showingMega: showingMega,
              megaIndex: megaIndex
            };
            console.log("Freezing stats:", frozenState);
            updatePokemon(currentPokemonId, false); // Refresh to apply frozen color
          } else {
            // Check if the current Pokémon and level match the frozen state
            const isSame = frozenState.id === currentPokemonId &&
                          frozenState.level === currentLevel &&
                          frozenState.showingMega === showingMega &&
                          frozenState.megaIndex === megaIndex;

            if (isSame) {
              // Unfreeze if clicking on the same Pokémon and level
              console.log("Unfreezing stats");
              frozenState = null;
              updatePokemon(currentPokemonId, false); // Refresh to apply default color
            } else {
              // Swap the frozen stats with the current stats
              const newPoints = radarArea.attr("points");
              console.log("Swapping frozen stats:", frozenState, "with new points:", newPoints);
              // Remove any existing frozen radar area
              d3.selectAll(".radar-area").filter(function() {
                return d3.select(this).attr("data-type") === "frozen";
              }).remove();
              // Add the new frozen radar area
              radarChart.append("polygon")
                .attr("class", "radar-area")
                .attr("data-type", "frozen")
                .attr("points", frozenState.points)
                .attr("fill", frozenColor)
                .attr("stroke", "#ecf0f1")
                .attr("stroke-width", 3);
              // Update the frozen state
              frozenState = {
                id: currentPokemonId,
                level: currentLevel,
                points: newPoints,
                showingMega: showingMega,
                megaIndex: megaIndex
              };
              updatePokemon(currentPokemonId, false); // Refresh to apply frozen color
            }
          }
        } else {
          console.error("No current radar area found to freeze.");
        }
      });

    // Parse EV Yield string into value and stat
    function parseEVYield(evYield) {
      const [value, stat] = evYield.split(" ");
      return { stat: stat, value: parseInt(value) };
    }

    // Calculate a stat based on base value, level, and EV yield
    function calculateStat(base, level, statName, evYield) {
      let EV = 0;
      const evData = evYield ? parseEVYield(evYield) : null;
      
      const statMap = {
        "HP": "HP",
        "ATK": "Attack",
        "DEF": "Defense",
        "SPA": "Special Attack",
        "SPD": "Special Defense",
        "SPE": "Speed"
      };

      if (evData && statMap[statName] === evData.stat) {
        EV = evData.value; // Apply EV if the stat matches
      }

      return Math.floor((base * 2 + Math.floor(EV / 4)) * level / 100) + level + 10;
    }

    // Adjust the Pokémon's level (up or down) without animation
    function adjustLevel(change) {
      currentLevel = Math.min(100, Math.max(1, currentLevel + change)); // Clamp level between 1 and 100
      levelText.text(`Lv.${currentLevel}`);
      updatePokemon(currentPokemonId, false); // Update without sprite animation
    }

    // Update the Pokédex display with the specified Pokémon
    async function updatePokemon(id, updateSprite) {
      try {
        const response = await fetch(`https://pokeapi.co/api/v2/pokemon/${id}/`);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const data = await response.json();
        const baseName = data.name.charAt(0).toUpperCase() + data.name.slice(1);
        // Find all Mega forms for the current Pokémon
        const allForms = Object.keys(pokemonStats).filter(k => k.startsWith(`Mega ${baseName}`));
        megaForms = allForms;

        // Determine which form to display (base or Mega)
        let displayName = showingMega && megaForms.length ? megaForms[megaIndex - 1] : baseName;
        const localData = pokemonStats[displayName];
        if (!localData || !localData.Type) {
          console.warn(`No data for Pokémon ID ${id}, skipping to next.`);
          return;
        }

        // Update the Pokémon name
        pokemonName.text(displayName.toUpperCase());
        // Highlight the Mega button if Mega forms exist
        megaButton.select("rect")
          .transition().duration(300)
          .attr("fill", megaForms.length > 0 ? "#4caf50" : "#2e7d32");

        // Update the sprite with disappear/reappear animation if requested
        if (updateSprite) {
          pokemonSprite.transition().duration(300)
            .attr("opacity", 0)
            .on("end", () => {
              pokemonSprite
                .attr("href", data.sprites.front_default)
                .attr("x", 165) // Fixed position, no directional shift
                .transition().duration(300)
                .attr("opacity", 1);
            });
        } else {
          pokemonSprite.attr("href", data.sprites.front_default);
        }

        // Update the type icons
        const types = localData.Type.split(',').map(t => t.toLowerCase().trim());
        const iconSize = 36, padding = 9, baseX = 91, baseY = 322;

        d3.select("#type-group").selectAll("image").remove();
        d3.select("#type-group")
          .selectAll("image")
          .data(types)
          .enter()
          .append("image")
          .attr("href", d => `icons/${d}.svg`)
          .attr("x", (d, i) => baseX + i * (iconSize + padding))
          .attr("y", baseY)
          .attr("width", iconSize)
          .attr("height", iconSize);

        // Calculate the Pokémon's stats based on the current level
        const stats = [
          calculateStat(localData["HP Base"], currentLevel, "HP", localData["EV Yield"]),
          calculateStat(localData["Attack Base"], currentLevel, "ATK", localData["EV Yield"]),
          calculateStat(localData["Defense Base"], currentLevel, "DEF", localData["EV Yield"]),
          calculateStat(localData["Special Attack Base"], currentLevel, "SPA", localData["EV Yield"]),
          calculateStat(localData["Special Defense Base"], currentLevel, "SPD", localData["EV Yield"]),
          calculateStat(localData["Speed Base"], currentLevel, "SPE", localData["EV Yield"])
        ];

        const maxStat = 450; // Maximum stat value for scaling the radar chart
        const radarData = stats.map(stat => (stat / maxStat) * radius);

        // Update the radar chart
        radarChart.selectAll(".radar-area").remove();
        const radarPolygon = radarChart.append("polygon")
          .attr("class", "radar-area")
          .attr("data-type", "current")
          .attr("points", radarData.map((value, i) => {
            const x = value * Math.cos(angleSlice * i - Math.PI / 2);
            const y = value * Math.sin(angleSlice * i - Math.PI / 2);
            return `${x},${y}`;
          }).join(" "))
          .attr("stroke", "#ecf0f1")
          .attr("stroke-width", 3);

        // Apply the correct fill color based on frozen state
        const isFrozen = frozenState &&
                        frozenState.id === currentPokemonId &&
                        frozenState.level === currentLevel &&
                        frozenState.showingMega === showingMega &&
                        frozenState.megaIndex === megaIndex;
        radarPolygon.attr("fill", isFrozen ? frozenColor : defaultColor);
        console.log(`Setting current radar fill to ${isFrozen ? frozenColor : defaultColor}`);

        // Add the frozen radar area if it exists and differs
        if (frozenState && !isFrozen) {
          radarChart.append("polygon")
            .attr("class", "radar-area")
            .attr("data-type", "frozen")
            .attr("points", frozenState.points)
            .attr("fill", frozenColor)
            .attr("stroke", "#ecf0f1")
            .attr("stroke-width", 3);
          console.log("Added frozen radar area with fill:", frozenColor);
        }

        // Update the stat display
        const statsDisplay = [
          `HP: ${stats[0]}`,
          `ATK: ${stats[1]}`,
          `DEF: ${stats[2]}`,
          `SPA: ${stats[3]}`,
          `SPD: ${stats[4]}`,
          `SPE: ${stats[5]}`
        ];

        d3.select("#stat-screen").selectAll("text").remove();
        d3.select("#stat-screen")
          .selectAll("text")
          .data(statsDisplay)
          .enter()
          .append("text")
          .attr("x", (d, i) => 520 + (i % 3) * 120)
          .attr("y", (d, i) => 480 + Math.floor(i / 3) * 30)
          .attr("class", "stat-label")
          .text(d => d);

        levelText.text(`Lv.${currentLevel}`);
      } catch (error) {
        console.error(`Error updating Pokémon ${id}:`, error);
        // Do not automatically scroll right; log and halt
      }
    }

    // Scroll to the next Pokémon
    function scrollRight() {
      currentPokemonId = currentPokemonId % totalPokemon + 1;
      showingMega = false;
      megaIndex = 0;
      currentLevel = 1;
      updatePokemon(currentPokemonId, true); // Update with sprite animation
    }

    // Scroll to the previous Pokémon
    function scrollLeft() {
      currentPokemonId = (currentPokemonId - 2 + totalPokemon) % totalPokemon + 1;
      showingMega = false;
      megaIndex = 0;
      currentLevel = 1;
      updatePokemon(currentPokemonId, true); // Update with sprite animation
    }
  </script>
</body>
</html>